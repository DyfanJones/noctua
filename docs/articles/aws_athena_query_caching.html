<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AWS Athena Query Caching • noctua</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="AWS Athena Query Caching">
<meta property="og:description" content="noctua">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">noctua</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/aws_athena_query_caching.html">AWS Athena Query Caching</a>
    </li>
    <li>
      <a href="../articles/aws_s3_backend.html">AWS S3 Backend</a>
    </li>
    <li>
      <a href="../articles/changing_backend_file_parser.html">Changing Backend File Parser</a>
    </li>
    <li>
      <a href="../articles/convert_and_save_cost.html">Convert and Save Cost</a>
    </li>
    <li>
      <a href="../articles/getting_started.html">Getting Started</a>
    </li>
    <li>
      <a href="../articles/how_to_retry.html">How to Retry?</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/DyfanJones/noctua/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="aws_athena_query_caching_files/header-attrs-2.10/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>AWS Athena Query Caching</h1>
                        <h4 class="author">Dyfan Jones</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DyfanJones/noctua/blob/master/vignettes/aws_athena_query_caching.Rmd"><code>vignettes/aws_athena_query_caching.Rmd</code></a></small>
      <div class="hidden name"><code>aws_athena_query_caching.Rmd</code></div>

    </div>

    
    
<div id="intro" class="section level1">
<h1 class="hasAnchor">
<a href="#intro" class="anchor"></a>Intro</h1>
<p><code>noctua</code> now supports caching. This was originally inspired by <code>pyathena</code>to reduce the cost of using <code>AWS Athena</code>. <code>noctua</code> however has a different caching method and utilities local caching in <code>R</code> environments instead of using AWS <code>list_query_executions</code>. This is down to <code>dbClearResult</code> clearing <code>AWS S3</code>’s <code>AWS Athena</code> output when caching is disabled.</p>
<div id="caching-benefits" class="section level2">
<h2 class="hasAnchor">
<a href="#caching-benefits" class="anchor"></a>Caching benefits</h2>
<p>By caching queries the performance of repeat queries is significantly improved. This is because the query is no longer sent to <code>AWS Athena</code>. Instead the query ID, of the repeating query, is taken from the R environment and the result is returned from <code>AWS S3</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org">DBI</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DyfanJones/noctua">noctua</a></span><span class="op">)</span>

<span class="va">con</span> <span class="op">=</span> <span class="fu"><a href="../reference/dbConnect,AthenaDriver-method.html">dbConnect</a></span><span class="op">(</span><span class="fu"><a href="../reference/athena.html">athena</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Start caching queries</span>
<span class="fu"><a href="../reference/noctua_options.html">noctua_options</a></span><span class="op">(</span>cache_size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>

<span class="co"># Upload Data to AWS Athena</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"iris"</span>, <span class="va">iris</span>, partition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Partition"</span> <span class="op">=</span> <span class="st">"01"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># initial query to AWS Athena</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span>df1 <span class="op">=</span> <span class="fu"><a href="../reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"select * from iris"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Info: (Data scanned: 3.63 KB)</span>
<span class="co">#   user  system elapsed </span>
<span class="co">#  0.105   0.004   3.397 </span>

<span class="co"># repeat query to AWS Athena</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span>df2 <span class="op">=</span> <span class="fu"><a href="../reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"select * from iris"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Info: (Data scanned: 3.63 KB)</span>
<span class="co">#   user  system elapsed </span>
<span class="co">#  0.072   0.000   0.348 </span></code></pre></div>
<p>Here we can see a performance increase of x10 with repeat query execution.</p>
</div>
<div id="caching-weakness" class="section level2">
<h2 class="hasAnchor">
<a href="#caching-weakness" class="anchor"></a>Caching weakness</h2>
<p>The weakness in caching occurs when the underlying data is updated. The cache will still only retrieve the previous query ID. This means that the new updated data won’t be return when the caching is enabled:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Updating iris table</span>
<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"iris"</span>, <span class="va">iris</span>, append <span class="op">=</span> <span class="cn">T</span>, partition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Partition"</span> <span class="op">=</span> <span class="st">"02"</span><span class="op">)</span><span class="op">)</span>

<span class="va">dt5</span> <span class="op">=</span> <span class="fu"><a href="../reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"select * from iris"</span><span class="op">)</span>

<span class="co"># Stop using cache data</span>
<span class="fu"><a href="../reference/noctua_options.html">noctua_options</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">dt6</span> <span class="op">=</span> <span class="fu"><a href="../reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"select * from iris"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dt5</span><span class="op">)</span>
<span class="co"># 150</span>

<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dt6</span><span class="op">)</span>
<span class="co"># 300</span></code></pre></div>
<p>Sadly the cached query didn’t pick up the new data from <code>iris</code>.</p>
</div>
<div id="cache-memory" class="section level2">
<h2 class="hasAnchor">
<a href="#cache-memory" class="anchor"></a>Cache memory</h2>
<p>The caching method in <code>noctua</code> will remember previous query ids within each R session, even if you stop and start caching in <code>noctua_options</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Start caching</span>
<span class="fu"><a href="../reference/noctua_options.html">noctua_options</a></span><span class="op">(</span>cache_size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="va">res1</span> <span class="op">=</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"select * from iris"</span><span class="op">)</span>

<span class="co"># Stop caching</span>
<span class="fu"><a href="../reference/noctua_options.html">noctua_options</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">res2</span> <span class="op">=</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"select * from iris"</span><span class="op">)</span>

<span class="co"># Start caching</span>
<span class="fu"><a href="../reference/noctua_options.html">noctua_options</a></span><span class="op">(</span>cache_size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="va">res3</span> <span class="op">=</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"select * from iris"</span><span class="op">)</span>

<span class="co"># Compare Query ID's</span>
<span class="va">res1</span><span class="op">@</span><span class="va">info</span><span class="op">$</span><span class="va">QueryExecutionId</span>
<span class="co"># 9a9272f5-0632-4774-9aa9-d07f151dabc5</span>

<span class="va">res2</span><span class="op">@</span><span class="va">info</span><span class="op">$</span><span class="va">QueryExecutionId</span>
<span class="co"># be12fe0-3ec0-4595-b3e6-b3bf67efa266</span>

<span class="va">res3</span><span class="op">@</span><span class="va">info</span><span class="op">$</span><span class="va">QueryExecutionId</span>
<span class="co"># 9a9272f5-0632-4774-9aa9-d07f151dabc5</span></code></pre></div>
<p>We can see that <code>res1</code> and <code>res3</code> utilise the same QueryID, even tho caching was stopped and started.</p>
</div>
<div id="clear-down-cache" class="section level2">
<h2 class="hasAnchor">
<a href="#clear-down-cache" class="anchor"></a>Clear down cache</h2>
<p>To clear down the cache, just set the parameter: <code>clear_cache</code> within <code>noctua_options</code> to <code>TRUE</code></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/noctua_options.html">noctua_options</a></span><span class="op">(</span>clear_cache <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Dyfan Jones.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
