<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Convert and Save Cost • noctua</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Convert and Save Cost">
<meta property="og:description" content="noctua">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">noctua</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.2.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/aws_athena_query_caching.html">AWS Athena Query Caching</a>
    </li>
    <li>
      <a href="../articles/aws_athena_unload.html">AWS Athena Unload</a>
    </li>
    <li>
      <a href="../articles/aws_s3_backend.html">AWS S3 Backend</a>
    </li>
    <li>
      <a href="../articles/changing_backend_file_parser.html">Changing Backend File Parser</a>
    </li>
    <li>
      <a href="../articles/convert_and_save_cost.html">Convert and Save Cost</a>
    </li>
    <li>
      <a href="../articles/getting_started.html">Getting Started</a>
    </li>
    <li>
      <a href="../articles/how_to_retry.html">How to Retry?</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/DyfanJones/noctua/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="convert_and_save_cost_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Convert and Save Cost</h1>
                        <h4 class="author">Dyfan Jones</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DyfanJones/noctua/blob/master/vignettes/convert_and_save_cost.Rmd"><code>vignettes/convert_and_save_cost.Rmd</code></a></small>
      <div class="hidden name"><code>convert_and_save_cost.Rmd</code></div>

    </div>

    
    
<div id="pricing-details" class="section level1">
<h1 class="hasAnchor">
<a href="#pricing-details" class="anchor"></a>Pricing Details</h1>
<blockquote>
<p>You are charged for the number of bytes scanned by Amazon Athena, rounded up to the nearest megabyte, with a 10MB minimum per query. There are no charges for Data Definition Language (DDL) statements like CREATE/ALTER/DROP TABLE, statements for managing partitions, or failed queries. Cancelled queries are charged based on the amount of data scanned.</p>
<p>Compressing your data allows Athena to scan less data. Converting your data to columnar formats allows Athena to selectively read only required columns to process the data. Athena supports Apache ORC and Apache Parquet. Partitioning your data also allows Athena to restrict the amount of data scanned. This leads to cost savings and improved performance. You can see the amount of data scanned per query on the Athena console. <a href="https://aws.amazon.com/athena/pricing/">link</a> So it becomes more important to compress your data and convert it to the recommended file formats <a href="https://parquet.apache.org/">Apache Parquet</a> or <a href="https://orc.apache.org/">Apache ORC</a>.</p>
</blockquote>
<p><strong>DON’T WORRY!!! <code>noctua</code> is here to help!</strong></p>
</div>
<div id="noctuas-help" class="section level1">
<h1 class="hasAnchor">
<a href="#noctuas-help" class="anchor"></a><code>noctua</code>’s help</h1>
<p>For a lot of users, <a href="https://parquet.apache.org/">Apache Parquet</a> or <a href="https://orc.apache.org/">Apache ORC</a> are file formats that aren’t well known and as a result alto systems don’t have the software to create these formats. <code>noctua</code> offers some assists by firstly enabling <code>apache parquet</code> format to be uploaded through <a href="https://dyfanjones.github.io/noctua/reference/AthenaWriteTables.html"><code>dbWriteTable</code></a>, using the R package <a href="https://arrow.apache.org/docs/r/"><code>arrow</code></a> to create the parquet format.</p>
<p>If uploading Apache Parquet is not possible or if the file format Apache ORC is preferred then <code>noctua</code> offers another solution. <code>noctua</code> can utilise the power of AWS Athena to convert file formats for you. What this allows you to do is:</p>
<ul>
<li>Upload Data in an easier file format for example delimited format</li>
<li>Convert Data into Parquet or ORC using AWS Athena to save cost</li>
<li>Finally insert into final table with ETL processes</li>
</ul>
<div id="upload-data-in-delimited-format" class="section level2">
<h2 class="hasAnchor">
<a href="#upload-data-in-delimited-format" class="anchor"></a>Upload Data in delimited format</h2>
<p>Uploading Data in delimited format is the easiest method.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org">DBI</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DyfanJones/noctua">noctua</a></span><span class="op">)</span>

<span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbConnect,AthenaDriver-method.html">dbConnect</a></span><span class="op">(</span><span class="fu"><a href="../reference/athena.html">athena</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="co"># create a temporary database to upload data into</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"CREATE IF NOT EXISTS DATABASE temp"</span><span class="op">)</span>
<span class="fu"><a href="../reference/dbClearResult.html">dbClearResult</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>

<span class="va">iris2</span> <span class="op">&lt;-</span> <span class="va">iris</span>
<span class="va">iris2</span><span class="op">$</span><span class="va">time_stamp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%Y%m%d"</span><span class="op">)</span>

<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"temp.iris_delim"</span>, <span class="va">iris2</span><span class="op">)</span></code></pre></div>
<p>However delimited file format isn’t the most cost effective when it comes to using AWS Athena. To overcome this we can convert this by using AWS Athena.</p>
</div>
<div id="convert-data-into-parquet-or-orc" class="section level2">
<h2 class="hasAnchor">
<a href="#convert-data-into-parquet-or-orc" class="anchor"></a>Convert Data into Parquet or ORC</h2>
<p>Converting table to a non-partitioned Parquet or ORC format.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># convert to parquet</span>
<span class="fu"><a href="../reference/dbConvertTable.html">dbConvertTable</a></span><span class="op">(</span><span class="va">con</span>,
               obj <span class="op">=</span> <span class="st">"temp.iris_delim"</span>,
               name <span class="op">=</span> <span class="st">"iris_parquet"</span>,
               file.type <span class="op">=</span> <span class="st">"parquet"</span><span class="op">)</span>
               
<span class="co"># convert to orc</span>
<span class="fu"><a href="../reference/dbConvertTable.html">dbConvertTable</a></span><span class="op">(</span><span class="va">con</span>,
               obj <span class="op">=</span> <span class="st">"temp.iris_delim"</span>,
               name <span class="op">=</span> <span class="st">"iris_orc"</span>,
               file.type <span class="op">=</span> <span class="st">"orc"</span><span class="op">)</span></code></pre></div>
<p><strong>NOTE:</strong> By default <code>dbConvertTable</code> compresses Parquet/ ORC format using <code>snappy</code> compression.</p>
<p><code>noctua</code> goes a step further by allowing tables to be converted with partitions.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># convert to parquet with partition time_stamp</span>
<span class="fu"><a href="../reference/dbConvertTable.html">dbConvertTable</a></span><span class="op">(</span><span class="va">con</span>,
               obj <span class="op">=</span> <span class="st">"temp.iris_delim"</span>,
               name <span class="op">=</span> <span class="st">"iris_parquet_partition"</span>,
               partition <span class="op">=</span> <span class="st">"time_stamp"</span>,
               file.type <span class="op">=</span> <span class="st">"parquet"</span><span class="op">)</span></code></pre></div>
<p><code>noctua</code> even allows SQL queries to be converted into desired file format:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/dbConvertTable.html">dbConvertTable</a></span><span class="op">(</span><span class="va">con</span>,
              obj <span class="op">=</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/SQL.html">SQL</a></span><span class="op">(</span><span class="st">"select 
                          Sepal_Length,
                          Sepal_Width,
                          date_format(current_date, '%Y%m%d') as time_stamp 
                        from temp.iris_delim"</span><span class="op">)</span>,
              name <span class="op">=</span> <span class="st">"iris_orc_partition"</span>,
              partition <span class="op">=</span> <span class="st">"time_stamp"</span>,
              file.type <span class="op">=</span> <span class="st">"orc"</span><span class="op">)</span></code></pre></div>
</div>
<div id="insert-into-table-for-etl-processes" class="section level2">
<h2 class="hasAnchor">
<a href="#insert-into-table-for-etl-processes" class="anchor"></a>Insert into table for ETL processes</h2>
<p>As we have created partitioned data, we can easily insert into:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"insert into iris_orc_partition
                  select 
                    Sepal_Length,
                    Sepal_Width, 
                    date_format(date_add('date', 1, current_date) , '%Y%m%d') time_stamp 
                  from temp.iris_delim"</span><span class="op">)</span>
<span class="fu"><a href="../reference/dbClearResult.html">dbClearResult</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></code></pre></div>
<p>What this all means is that you can create ETL processes by uploading data in basic file format (delimited), and then converting / inserting into the prefer file format.</p>
</div>
<div id="dplyr-method" class="section level2">
<h2 class="hasAnchor">
<a href="#dplyr-method" class="anchor"></a><code>dplyr</code> method</h2>
<p>The good news doesn’t stop there, <code>noctua</code> integrates with <code>dplyr</code> to allow converting to be done through <code>dplyr</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="va">iris_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu">dbplyr</span><span class="fu">::</span><span class="fu"><a href="https://dbplyr.tidyverse.org/reference/in_schema.html">in_schema</a></span><span class="op">(</span><span class="st">"temp"</span>, <span class="st">"iris_delim"</span><span class="op">)</span><span class="op">)</span>

<span class="va">r_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%Y%m%d"</span><span class="op">)</span>

<span class="va">iris_tbl</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">petal_length</span>,
         <span class="va">petal_width</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>time_stamp <span class="op">=</span> <span class="va">r_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span><span class="op">(</span><span class="st">"iris_dplyr_parquet"</span>, partition <span class="op">=</span> <span class="st">"time_stamp"</span>, file_type <span class="op">=</span> <span class="st">"parquet"</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="reading-material" class="section level1">
<h1 class="hasAnchor">
<a href="#reading-material" class="anchor"></a>Reading Material</h1>
<ul>
<li><a href="https://docs.aws.amazon.com/athena/latest/ug/ctas-insert-into-etl.html">CTAS insert into ETL</a></li>
<li><a href="https://docs.aws.amazon.com/athena/latest/ug/considerations-ctas.html">Considerations and Limitations for CTAS Queries</a></li>
<li><a href="https://docs.aws.amazon.com/athena/latest/ug/ctas-examples.html">Examples of CTAS Queries</a></li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Dyfan Jones.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
